<?xml version="1.0" encoding="UTF-8"?>
<JdbcEntitySetup xmlns="http://www.ontimize.com/schema/jdbc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
xsi:schemaLocation="http://www.ontimize.com/schema/jdbc http://www.ontimize.com/schema/jdbc/ontimize-jdbc-dao.xsd" 
catalog="" schema="${mainschema}" table="hotels" datasource="mainDataSource" sqlhandler="dbSQLStatementHandler">
	<DeleteKeys>
		<Column>htl_id</Column>
	</DeleteKeys>
	<UpdateKeys>
		<Column>htl_id</Column>
	</UpdateKeys>
	<GeneratedKey>htl_id</GeneratedKey>	
	 <Queries>
  	<Query id="queryHotel">
   	<Sentence>
   	<![CDATA[
     SELECT
      #COLUMNS#
     FROM
      public.hotels
     #WHERE#
   ]]>
   </Sentence>
  </Query>
  <Query id="queryHotelOccupancy">
  <Sentence>
  <![CDATA[
   SELECT htl_id,htl_name, htl_city, count(bgs_cst_id) as htl_occupancy
    FROM hotels
    LEFT JOIN rooms ON rm_htl_id = htl_id
    LEFT JOIN bookings ON rm_id = bkg_rm_id
    LEFT JOIN bookings_guests ON bkg_id = bgs_bkg_id
    #WHERE#
    GROUP BY htl_id
    ORDER BY htl_id
]]>
  </Sentence>
  </Query>
   <Query id="queryHotelMaximunCapacity">
  <Sentence>
  <![CDATA[
   SELECT htl_id,htl_name, htl_city, sum(bdc_slots) as htl_maximum_capacity
	FROM hotels 
	LEFT JOIN rooms ON rm_htl_id = htl_id
	LEFT JOIN room_types rmt ON rmt_id = rm_rmt_id
	LEFT JOIN beds_combo ON bdc_id = rmt_bdc_id
	#WHERE#
	GROUP BY htl_id
	ORDER BY htl_id
]]>
  </Sentence>
  </Query>
   <Query id="queryHotelOccupancyRate">
  <Sentence>
  <![CDATA[
   SELECT aux.htl_id, aux.htl_name, aux.htl_city, htl_maximum_capacity, htl_occupancy, ROUND(((CAST(htl_occupancy AS NUMERIC)/CAST(htl_maximum_capacity AS NUMERIC))*100),2) AS htl_occupancy_rate
	FROM 
	(SELECT htl_id, htl_name, htl_city, sum(bdc_slots) AS htl_maximum_capacity
		FROM hotels 
		LEFT JOIN rooms ON rm_htl_id = htl_id
		LEFT JOIN room_types rmt ON rmt_id = rm_rmt_id
		LEFT JOIN beds_combo ON bdc_id = rmt_bdc_id
		GROUP BY htl_id
		ORDER BY htl_id) AS aux	
	LEFT JOIN 
	(SELECT htl_id, htl_name, htl_city, count(bgs_cst_id) AS htl_occupancy
		FROM hotels
		LEFT JOIN rooms ON rm_htl_id = htl_id
		LEFT JOIN bookings ON rm_id = bkg_rm_id
		LEFT JOIN bookings_guests ON bkg_id = bgs_bkg_id
		#WHERE#
	GROUP BY htl_id
	ORDER BY htl_id) AS aux2
	USING(htl_id)
	]]>
  </Sentence>
  </Query>
  <Query id="queryHotelOccupancyDailyRate">
  <Sentence>
  <![CDATA[
  SELECT aux.htl_id, aux.htl_name, aux.htl_city, checkin, capacity, occupancy, ROUND(((CAST(occupancy AS NUMERIC)/CAST(capacity AS NUMERIC))*100),2)  AS occupancy_rate
FROM 
(SELECT htl_id, htl_name, htl_city, sum(bdc_slots) AS capacity
	FROM hotels 
	LEFT JOIN rooms ON rm_htl_id = htl_id
	LEFT JOIN room_types rmt ON rmt_id = rm_rmt_id
	LEFT JOIN beds_combo ON bdc_id = rmt_bdc_id
	GROUP BY htl_id
	ORDER BY htl_id) AS aux	
LEFT JOIN 
(SELECT htl_id,htl_name,htl_city,TO_DATE(TO_CHAR(bkg_checkin::DATE,'yyyy-mm-dd'),'yyyy-mm-dd') AS checkin, count(bgs_cst_id) AS occupancy
FROM hotels
	LEFT JOIN rooms ON rm_htl_id = htl_id
	LEFT JOIN bookings ON rm_id = bkg_rm_id
	LEFT JOIN bookings_guests ON bkg_id = bgs_bkg_id
	#WHERE#
	GROUP BY TO_DATE(TO_CHAR(bkg_checkin::DATE,'yyyy-mm-dd'),'yyyy-mm-dd'),htl_id,htl_name,htl_city) AS aux2
USING(htl_id);
]]>
  </Sentence>
  </Query>
 </Queries>
</JdbcEntitySetup>